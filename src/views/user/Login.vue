<template>
  <v-flex xs12>
    <v-card>
      <v-card-title class="py-4 title">Login</v-card-title>
      <v-container grid-list-sm class="pa-4">
        <v-form>
          <v-layout row wrap>
            <v-flex xs12 justify-space-between>
              <v-text-field
                label="Email"
                v-model="email"
                v-validate="'required|email'"
                type="text"
                name="email"
                :error-messages="errors.collect('email')"
              ></v-text-field>
            </v-flex>
            <v-flex xs12>
              <v-text-field
                v-model="password"
                :append-icon="show ? 'visibility_off' : 'visibility'"
                v-validate="{required: true, min: 6, max: 25 }"
                :type="show ? 'text' : 'password'"
                label="Password"
                name="password"
                :error-messages="errors.collect('password')"
                counter
                @click:append="show = !show"
              ></v-text-field>
            </v-flex>
          </v-layout>
        </v-form>
        <vue-recaptcha
          ref="recaptcha"
          :sitekey="sitekey"
          @verify="onCaptchaSuccess"
          @expired="onCaptchaExpired"
        />
        <message/>
      </v-container>
      <v-card-actions>
        <v-btn to="/register" color="red darken-2" flat>Create account</v-btn>
        <v-spacer></v-spacer>
        <v-btn 
          color="red darken-2" 
          :dark="!isSubmitDisabled"
          :disabled="isSubmitDisabled"
          @click="submit">
            submit
        </v-btn>
      </v-card-actions>
      <v-flex v-if="loading">
        <v-progress-linear ma-0 :indeterminate="true"></v-progress-linear>
      </v-flex>
    </v-card>
  </v-flex>
</template>

<script>
import message from '@/components/Message.vue'
import VueRecaptcha from 'vue-recaptcha'

export default {
  name: 'Login',
  data () {
    return {
      email: '',
      password: '',
      show: false,
      sitekey: '6Lev1Z4UAAAAAGPygpI3kfg-qT8giGp0xw97gzXC',
      isSubmitDisabled: true
    }
  },
  computed: {
    user() {
      return this.$store.getters.user
    },
    userData() {
      if (this.$store.getters.userData) return this.$store.getters.userData
    },
    loading() {
      return this.$store.getters.loading
    }
  },
  methods: {
    onCaptchaExpired () {
      this.$refs.recaptcha.reset()
    },
    onCaptchaSuccess () {
      this.isSubmitDisabled = false
    },
    submit: function() {
      let router = this.$router
      this.$validator.validate().then(result => {
        if (result) {
          let credentials = {
            email: this.email,
            password: this.password
          }
          this.$store.dispatch('signIn', credentials)
        }
      })
    }
  },
  watch: {
    userData(newVal, oldVal) {
      if (newVal && newVal !== undefined) {
        this.$router.push('/user_' + this.userData.username)
      }
    }
  },
  components: {
    message,
    VueRecaptcha
  }
}
</script>
